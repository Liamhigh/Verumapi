name: Deploy to Firebase and Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy-web:
    name: Deploy Web App to Firebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build web app
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: npm run build

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_VERUM_OMNIS_V2 }}"
          channelId: live
          projectId: verum-omnis-v2

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: deploy-web  # Run after web deployment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: npm install

      - name: Build web app
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > release.keystore
            echo "Keystore decoded successfully"
          else
            echo "Warning: ANDROID_KEYSTORE_BASE64 secret not set. Skipping keystore setup."
            echo "The APK will be built unsigned."
          fi

      - name: Create keystore.properties
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          if [ -f release.keystore ]; then
            cat > android/keystore.properties << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=${ANDROID_KEY_ALIAS:-upload}
          storeFile=../release.keystore
          EOF
            echo "keystore.properties created"
          else
            echo "Skipping keystore.properties creation (no keystore available)"
          fi

      - name: Build Android APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error

      - name: Get version info
        id: version
        run: |
          VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Verum Omnis Release
            
            **Version:** ${{ steps.version.outputs.version }}
            **Build Date:** ${{ steps.version.outputs.build_date }}
            **Commit:** ${{ github.sha }}
            **Triggered by:** ${{ github.event_name }}
            
            ### Changes
            ${{ github.event.head_commit.message || 'Manual workflow trigger' }}
            
            ### Downloads
            - Android APK: app-release.apk
            - Web App: Deployed to Firebase Hosting
            
            ### Installation
            1. Download the APK file
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK
            
            Or visit the web app at your Firebase Hosting URL.
          files: |
            android/app/build/outputs/apk/release/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
